"use strict";(self.webpackChunkeducation_docs=self.webpackChunkeducation_docs||[]).push([[6594],{7987:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>r,default:()=>l,frontMatter:()=>i,metadata:()=>a,toc:()=>d});var o=n(4848),s=n(8453);const i={},r="Persisting Connectivity in Web3 with useEffect",a={id:"courses/blockchain-developer-bootcamp/S04-developer-tooling/M7-web3-frontend/L3-persisting-connectivity/index",title:"Persisting Connectivity in Web3 with useEffect",description:"This lesson builds on the CodeSandbox example from \u201cA Demystification of \u201cConnect Wallet\u201d",source:"@site/docs/courses/blockchain-developer-bootcamp/S04-developer-tooling/M7-web3-frontend/L3-persisting-connectivity/index.md",sourceDirName:"courses/blockchain-developer-bootcamp/S04-developer-tooling/M7-web3-frontend/L3-persisting-connectivity",slug:"/courses/blockchain-developer-bootcamp/S04-developer-tooling/M7-web3-frontend/L3-persisting-connectivity/",permalink:"/educationdao.xyz/docs/courses/blockchain-developer-bootcamp/S04-developer-tooling/M7-web3-frontend/L3-persisting-connectivity/",draft:!1,unlisted:!1,tags:[],version:"current",lastUpdatedBy:"oliver renwick",lastUpdatedAt:1721055769e3,frontMatter:{},sidebar:"docSidebar",previous:{title:"Ethereum .on Events",permalink:"/educationdao.xyz/docs/courses/blockchain-developer-bootcamp/S04-developer-tooling/M7-web3-frontend/L3-ethereum-on-events/"},next:{title:"Second-Order Effects",permalink:"/educationdao.xyz/docs/courses/blockchain-developer-bootcamp/S05a-defi/M0-concepts/"}},c={},d=[{value:"Why do you stay connected?",id:"why-do-you-stay-connected",level:2},{value:"Showing your user\u2019s connectivity",id:"showing-your-users-connectivity",level:2},{value:"Why did we unpack <code>ethereum</code> from <code>window</code>?",id:"why-did-we-unpack-ethereum-from-window",level:2},{value:"Additional Reading (or just references)",id:"additional-reading-or-just-references",level:2}];function h(e){const t={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(t.h1,{id:"persisting-connectivity-in-web3-with-useeffect",children:"Persisting Connectivity in Web3 with useEffect"}),"\n",(0,o.jsx)(t.p,{children:(0,o.jsx)(t.em,{children:"This lesson builds on the CodeSandbox example from \u201cA Demystification of \u201cConnect Wallet\u201d"})}),"\n",(0,o.jsx)(t.p,{children:"What actually happens when you leave a dApp and why are you still connected? For this, let\u2019s hop in a time machine."}),"\n",(0,o.jsx)(t.p,{children:"The year is 2006. You\u2019ve just spent the last three hours fine-tuning the spaghetti code that makes up your MySpace layout to show off to all the new frens you got from that bulletin board S4S. You\u2019re good at this, way ahead of your time. You do this all in Notepad\u2014 in plain text with no syntax highlighting."}),"\n",(0,o.jsx)(t.p,{children:"Life is good until you receive a seemingly innocuous email prompting you to visit MySpace with a strange URL. On login, the site looks a little different. By the way, you did log in. It didn\u2019t take you back to MySpace, so you open up a new window and see that now your whole bulletin board is flooded with spam from your account. The credentials you used to log in don\u2019t work anymore. Your layout is broken now and your profile photo has changed."}),"\n",(0,o.jsxs)(t.p,{children:["You were the victim of a ",(0,o.jsx)(t.a,{href:"https://www.computerworld.com/article/2815426/myspace-again-under-phishing-attack.html",children:"phishing attack"}),". It happens all too often, unfortunately. ",(0,o.jsx)(t.a,{href:"https://www.fbi.gov/scams-and-safety/common-scams-and-crimes/spoofing-and-phishing",children:"You get emails telling you that something completely out of your control, and sometimes beyond your comprehension, has happened to your account, here\u2019s how you can fix it"}),". Phishing attacks have bamboozled users online since the time ",(0,o.jsx)(t.a,{href:"https://cofense.com/knowledge-center/history-of-phishing/",children:"you were able to get a 30-day free trial of \u2728the internet\u2728from an AOL floppy disk"}),". We can try to rely on a site logging us in automatically to circumvent this attack because when a site logs us in automatically, it does us a few favors. It reduces the password fatigue that has already burnt us out. And it reminds us to take a step back from this email and visit the site with a URL we know and trust to make sure everything is okay. If the site remembers us, we should be okay, right?"]}),"\n",(0,o.jsx)(t.p,{children:"Just because we can try to rely on auto-login doesn\u2019t mean we should. We\u2019re really relying on the possibility a site may allow for that. That our browser data wasn\u2019t purged. The problem is that it\u2019s not set in stone, we don\u2019t know if we\u2019ll always be logged in. But wait, it can get worse. Auto-login is not entirely a good thing to rely on. If your device ends up in the wrong hands, now whoever has it can also access the same sites that promised to remember you. It\u2019s no longer a convenience at that point, but an attack vector."}),"\n",(0,o.jsx)(t.h2,{id:"why-do-you-stay-connected",children:"Why do you stay connected?"}),"\n",(0,o.jsxs)(t.p,{children:["Phishing never really went away. ",(0,o.jsx)(t.a,{href:"https://twitter.com/troyhunt/status/1508184697070780418",children:"It just got smarter"}),". Now the stakes are higher because real assets are involved."]}),"\n",(0,o.jsxs)(t.p,{children:["If you force quit and restart your browser. Notice how the button still says \u2018Connect\u2019. Click it and it should open MetaMask, now you have to enter your password for MetaMask because you were logged out. But, do you notice how you\u2019ve connected to the dApp again, and you didn\u2019t have to select an account to connect with? If you don\u2019t remember disconnecting or logging out, ",(0,o.jsx)(t.em,{children:"it\u2019s because you didn\u2019t."})]}),"\n",(0,o.jsx)(t.p,{children:"Your session wasn\u2019t retained in local storage, but after restarting your browser, you were logged out of MetaMask\u2014 this is by design. Your device can fall into the wrong hands, but unless they know your password for MetaMask, your private key, or your mnemonic phrase, they can\u2019t do anything. They can\u2019t even get your private key or mnemonic phrase from MetaMask because they need your password!"}),"\n",(0,o.jsxs)(t.p,{children:["But wait, there\u2019s more! The only reason why you will ever need to use your private key or mnemonic phrase is if you\u2019re importing accounts from other wallets. You don\u2019t use it often like regular credentials and are encouraged to store it in some place like a safety deposit box, ",(0,o.jsx)(t.em,{children:"(or entombed in concrete)"}),". In the meantime, here\u2019s what your junk mailbox can get filled with."]}),"\n",(0,o.jsxs)(t.p,{children:[(0,o.jsx)(t.img,{alt:"https://dev-to-uploads.s3.amazonaws.com/uploads/articles/srpl360r83f2craj9wrh.png",src:n(6250).A+"",width:"1716",height:"2322"}),"\n",(0,o.jsx)(t.a,{href:"https://www.youtube.com/watch?v=MK6TXMsvgQg",children:(0,o.jsx)(t.em,{children:"Benny Hill theme intensifies"})})]}),"\n",(0,o.jsx)(t.p,{children:"By default, you\u2019ll always be connected because you didn\u2019t need to verify your identity for authentication. The mere fact that your account was generated from a number so large that it could not be manmade is proof enough that your account is authentic. The reason why you stay connected is that you granted this dApp permission to view your accounts, and your assets and suggest transactions on your behalf. Restarting your browser, clearing your session, and clearing your cookies and cache doesn\u2019t disconnect you. Because MetaMask and other browser wallets act as this bridge between you and dApps, it supplies the functionality for dApps to check if you have granted permissions with your account with the Ethereum Provider API."}),"\n",(0,o.jsx)(t.p,{children:"Malicious actors can then fork popular protocols and spin up their own versions and deceive you into thinking you might be interacting with the real protocol, but you\u2019re greeted with a new user flow as if permissions only you could grant and revoke were automatically granted and revoked for you, without your explicit consent."}),"\n",(0,o.jsx)(t.p,{children:"This is why connectivity and permissions in Web3.0 is a paradigm shift from traditional authentication flows in Web2.0."}),"\n",(0,o.jsx)(t.h2,{id:"showing-your-users-connectivity",children:"Showing your user\u2019s connectivity"}),"\n",(0,o.jsxs)(t.p,{children:["To display this persistent connectivity with React, we\u2019ll need to make a few more tweaks. For this, we can use the ",(0,o.jsx)(t.a,{href:"https://reactjs.org/docs/hooks-effect.html",children:"Effect"})," hook. React components are dynamic because of their ability to go through different ",(0,o.jsx)(t.a,{href:"https://reactjs.org/docs/state-and-lifecycle.html#adding-lifecycle-methods-to-a-class",children:"lifecycles"}),'. You\'ll commonly see the phrase "side effect" used in explanations for ',(0,o.jsx)(t.code,{children:"useEffect"}),", so a side effect of the Ethereum Provider API being present in the ",(0,o.jsx)(t.code,{children:"window"})," results in either the \u2018Connect\u2019 button or the \u2018Address\u2019 component being rendered."]}),"\n",(0,o.jsxs)(t.p,{children:["In ",(0,o.jsx)(t.code,{children:"App.js"})," you\u2019ll see we\u2019re already importing ",(0,o.jsx)(t.code,{children:"useEffect"})," from React. Now we can define it right beneath our ",(0,o.jsx)(t.code,{children:"useState"})," hook like this:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-jsx",children:"useEffect(() => {\n  // Callback function\n}, []) // Dependency array\n"})}),"\n",(0,o.jsxs)(t.p,{children:["Logic can fire off in a component where we\u2019re using ",(0,o.jsx)(t.code,{children:"useEffect"})," and it can change state, and ultimately how our components and our app look. That array is where you have a variable that needs to change before the callback function can fire off. So perhaps we\u2019re waiting on something to exist, like say\u2026 an Ethereum provider, we can then fire off a callback function in our ",(0,o.jsx)(t.code,{children:"useEffect"})," to show the address that a user has connected with."]}),"\n",(0,o.jsxs)(t.p,{children:["First, you\u2019ll need to destructure the ",(0,o.jsx)(t.code,{children:"window"})," object to unpack the ",(0,o.jsx)(t.code,{children:"ethereum"})," property and define it as its own variable like this:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-jsx",children:"const { ethereum } = window\n"})}),"\n",(0,o.jsxs)(t.p,{children:["And then let\u2019s quickly change wherever we have ",(0,o.jsx)(t.code,{children:"window.ethereum"}),"  to ",(0,o.jsx)(t.code,{children:"ethereum"}),", like in our connect function:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-jsx",children:'const accounts = (\n  await ethereum.request({ method: "eth_requestAccounts" })\n  await window.ethereum.request({ method: "eth_requestAccounts" })\n)[0];\n'})}),"\n",(0,o.jsxs)(t.p,{children:["And also in our ",(0,o.jsx)(t.code,{children:"<main>"})," element:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-jsx",children:"<main>\n  {account \n\t\t? <Account address={account} />\n\t\t: ethereum\n\t\t? <ConnectButton connect={connect} />\n\t  : <InstallMetaMask />\n  )}\n</main>\n"})}),"\n",(0,o.jsxs)(t.p,{children:["Now let\u2019s go back to the ",(0,o.jsx)(t.code,{children:"useEffect"}),". We know at some point, on load, the Ethereum Provider in our window will return an object, but until it does, we want to hold off on firing any logic. So now we can throw that into our dependency array like this:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-jsx",children:"useEffect(() => {\n  // Logic will fire off here if Ethereum changes from undefined to defined.\n}, [ethereum])\n"})}),"\n",(0,o.jsxs)(t.h2,{id:"why-did-we-unpack-ethereum-from-window",children:["Why did we unpack ",(0,o.jsx)(t.code,{children:"ethereum"})," from ",(0,o.jsx)(t.code,{children:"window"}),"?"]}),"\n",(0,o.jsxs)(t.p,{children:["Using ",(0,o.jsx)(t.code,{children:"window.ethereum"})," in our dependency array would break one of the rules of React Hooks. This would trigger the ",(0,o.jsx)(t.code,{children:"react-hooks/exhaustive-deps"})," warning that tells us that ",(0,o.jsx)(t.code,{children:"window.ethereum"})," is an outer scope value, and that changing it will not re-render the component."]}),"\n",(0,o.jsxs)(t.p,{children:["For a while, we were checking if ",(0,o.jsx)(t.code,{children:"window.ethereum"})," existed, if console logging it would return a truthy value. If it doesn\u2019t exist, the value returned will be false. But we were never checking if it changed while it was in the ",(0,o.jsx)(t.code,{children:"window"}),", or if the ",(0,o.jsx)(t.code,{children:"window"})," as a whole changed."]}),"\n",(0,o.jsxs)(t.p,{children:["What if ",(0,o.jsx)(t.code,{children:"window"})," does change, but ",(0,o.jsx)(t.code,{children:"ethereum"})," doesn\u2019t? This is where the issue of it being an outer scope value comes into play because we\u2019re relying on ",(0,o.jsx)(t.code,{children:"ethereum"})," while it\u2019s ",(0,o.jsx)(t.strong,{children:"inside"})," ",(0,o.jsx)(t.code,{children:"window"}),", instead of ",(0,o.jsx)(t.code,{children:"ethereum"})," when it\u2019s defined on its own. We\u2019ll see a scenario where a side effect turns into a butterfly effect as one rabid dependency triggers a series of unfortunate re-renders. We don\u2019t want this, so ",(0,o.jsx)(t.code,{children:"react-hooks/exhaustive-deps"})," fire off to let us know we may end up with this kind of behavior."]}),"\n",(0,o.jsxs)(t.p,{children:["Next, we can call the JSON-RPC method: ",(0,o.jsx)(t.code,{children:"eth_accounts"}),". We don\u2019t have to request accounts from a user because they already granted our dApp permission. We instead get to see if they\u2019ve connected with the account they are currently using. This is another promise that returns an array. So we\u2019ll have to use the same syntax with ",(0,o.jsx)(t.code,{children:"await"})," that we used with our connect function, like this:"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-jsx",children:"useEffect(() => {\n\t(async () => {\n\t\t// Why it look like that ser?\n\t})()\n}, [ethereum])\n"})}),"\n",(0,o.jsxs)(t.p,{children:["This looks the way it does because it is an async IIFE, an ",(0,o.jsx)(t.a,{href:"https://developer.mozilla.org/en-US/docs/Glossary/IIFE",children:"immediately invoked function expression"}),". The parentheses have a job title now as a \u2018grouping operator\u2019, and this is where we throw in our logic. Then the second set of parentheses at the end is where we immediately call that anonymous function. Because we aren\u2019t reusing this function anywhere else at the moment, we don\u2019t need to explicitly name it."]}),"\n",(0,o.jsxs)(t.p,{children:["Inside our IIFE, we can throw in a ",(0,o.jsx)(t.code,{children:"try/catch"})," block."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-jsx",children:"useEffect(() => {\n\t(async () => {\n\t\ttry {\n\t\t\t// You've done this before\n\t\t} catch (e) {}\n\t})()\n}, [ethereum])\n"})}),"\n",(0,o.jsx)(t.p,{children:"And now we can make that API call:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-jsx",children:"useEffect(() => {\n\t(async () => {\n\t\ttry {\n\t\t\tconst connectedAccount = (await ethereum.request({method: 'eth_accounts'})[0]\n\t\t\tsetAccount(connectedAccount);\n\t\t} catch (e) {\n\t\t\tconsole.log(e)\n\t\t}\n\t})()\n}, [ethereum])\n"})}),"\n",(0,o.jsxs)(t.p,{children:["As long as you haven\u2019t revoked permissions, you should see immediately that the ",(0,o.jsx)(t.code,{children:"<Account />"})," component with your address is present. On refresh, it\u2019ll still be there. All up until you manually disconnect with MetaMask\u2014 and then strangely, notice how the ",(0,o.jsx)(t.code,{children:"<Account />"})," component is still present?"]}),"\n",(0,o.jsx)(t.p,{children:"This might be confusing for your users who are expecting a \u2018Disconnect\u2019 button to replace a logout button. But if you look for it in components, there isn\u2019t one there. We simply don\u2019t have one. This is also by design, you see, a dApp can\u2019t facilitate this request to just revoke the permissions you granted. It doesn\u2019t have permission to do so because it\u2019s not you. You can stay connected, but even then transactions cannot be approved and messages cannot be signed without you, as the private key holder, confirming them."}),"\n",(0,o.jsx)(t.p,{children:"If your user takes a certain action like disconnecting, and they\u2019re doing that through MetaMask, the dApp frontend needs to know what just occurred, and what to do next. In the next lesson, we\u2019ll cover event listeners with the Ethereum Provider API."}),"\n",(0,o.jsx)(t.h2,{id:"additional-reading-or-just-references",children:"Additional Reading (or just references)"}),"\n",(0,o.jsxs)(t.ul,{children:["\n",(0,o.jsx)(t.li,{children:(0,o.jsx)(t.a,{href:"https://docs.metamask.io/guide/ethereum-provider.html",children:"Ethereum Provider API"})}),"\n",(0,o.jsx)(t.li,{children:(0,o.jsxs)(t.a,{href:"https://blog.logrocket.com/guide-to-react-useeffect-hook/",children:["A Guide to React's ",(0,o.jsx)(t.code,{children:"useEffect"})," hook"]})}),"\n",(0,o.jsx)(t.li,{children:(0,o.jsxs)(t.a,{href:"https://overreacted.io/a-complete-guide-to-useeffect/",children:["A Complete Guide to ",(0,o.jsx)(t.code,{children:"useEffect"})]})}),"\n"]})]})}function l(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(h,{...e})}):h(e)}},6250:(e,t,n)=>{n.d(t,{A:()=>o});const o=n.p+"assets/images/persisting-connectivity-inbox-c2d6b6b1d64a9488cf5f689771910dc6.png"},8453:(e,t,n)=>{n.d(t,{R:()=>r,x:()=>a});var o=n(6540);const s={},i=o.createContext(s);function r(e){const t=o.useContext(i);return o.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),o.createElement(i.Provider,{value:t},e.children)}}}]);